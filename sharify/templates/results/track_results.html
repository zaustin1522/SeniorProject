{% load static %}
{% if results %}
<table>
    {% for row in results %}
    <tr>
        {% for entry in row %}
            {% with track_id=entry.0.track_id %}
            <td style="position: relative; vertical-align:top; border: 5px solid rgba(0,0,0,0);">
                <a href="/track/?id={{track_id}}" target="_blank" style="color:white;">
                    <div style="display: flex; flex-direction: row; min-width: 500px; max-width: 500px; max-height: 125px; min-height: 125px; padding: 12px; border-radius: 1.25rem; background-color: rgba(255,255,255,.25);">
                        <img src="{{entry.0.image_url}}" style="max-width: 100px; border-radius: 1rem; aspect-ratio: 1/1;"/>
                        <div style="flex-direction: column; margin: auto; margin-left: 24px; margin-right: 70px; max-height: 100px; overflow-y: scroll;">
                            <h4 style="font-weight: bolder;">{{entry.0.track_name}}</h4>
                            <h6>{{entry.0.artist}}</h6>
                        </div>
                    </div>
                </a>
                <img src="{% static 'images/down_button.png' %}" frame="{{track_id}}" onclick="expand(this)" style="position: absolute; right: 10px; top: 40px; border-radius: 25px; background-color: rgba(255, 255, 255, .5); max-width: 50px; aspect-ratio: 1/1;"/>
                {% if not user.is_authenticated %}
                    <div id="{{track_id}}" style="position: absolute; z-index: 10; right: -120px; top: 100px; border: 5px solid white; border-radius: 1.1rem; max-width: 310px; height: 362px; background-color: white;" hidden="true">
                        <iframe src="https://open.spotify.com/embed/track/{{ track_id }}" width="310" height="362" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
                    </div>
                {% else %}
                <div id="{{track_id}}" style="display: flex; flex-direction: row; position: absolute; z-index: 10; right: -70px; top: 100px; border: 5px solid white; border-radius: 1.1rem; min-width: 640px; max-width: 640px; height: 362px; background-color: white;" hidden="true">
                    <iframe style="max-width: 310px;" src="https://open.spotify.com/embed/track/{{ track_id }}" width="310" height="362" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
                    <div style="display: flex; flex-direction: column; margin-left: 5px; padding: 12px; min-width: 325px; max-width: 325px; border-radius: .75rem; background-color: rgba(0, 0, 0, .75); color: white;">
                        {% if playlists %}
                            {% include 'social/playlist_selector.html' %}
                        {% endif %}
                        {% with comments=entry.1 %}
                            {% include 'social/comment.html' %}
                        {% endwith %}
                    </div>
                </div>
                {% endif %}
            </td>
            {% endwith %}
        {% endfor %}
    </tr>
    {% endfor %}
</table>
{% endif %}

{% block scripts %}
    <script>
        let http = new XMLHttpRequest
        var username = ""
        var comment_text = ""
        var target_id = ""

        function expand(elem) {
            if (document.getElementById("active")){
                shrink(document.getElementById("active"))
            }
            target_id = elem.getAttribute("frame");
            target = document.getElementById(target_id);
            target.hidden = false;
            elem.style.setProperty("transform", "rotate(180deg)");
            elem.setAttribute("onclick", "shrink(this)");
            elem.setAttribute("id", "active");
        }
        function shrink(elem) {
            elem.removeAttribute("id");
            target_id = elem.getAttribute("frame");
            target = document.getElementById(target_id);
            target.hidden = true;
            elem.style.setProperty("transform", "rotate(0deg)");
            elem.setAttribute("onclick", "expand(this)");
        }
        function commenting(elem) {
            target_id = elem.getAttribute("track-id");
            username = elem.getAttribute("username");
            comment_text = elem.value;
            comment = encodeURIComponent(comment_text);
            let url = '/comment/?track_id=' + target_id + "&comment=" + comment;
            http.open('GET', url);
            http.send(null);
            elem.value = "";
        }

        http.onload = () => {
        console.log('DONE: ', http.status);
        if (http.status == 201) {
            var comment_box = document.getElementById("comments-on-" + target_id)
            var new_comment = document.createElement("div");
            new_comment.style = "flex-direction: row;  text-align: left; padding-left: 4px; background-color: rgba(0,0,0,.5); margin: 0 4px 4px; color: white; border-radius: .5rem;";
            var user_node = document.createElement("h6");
            user_node.style = "display: inline; font-weight: bold;";
            user_node.innerHTML = username + ": ";
            var comment_node = document.createElement("p");
            comment_node.style = "display: inline;";
            comment_node.innerHTML = comment_text;
            new_comment.appendChild(user_node);
            new_comment.appendChild(comment_node);
            comment_box.insertBefore(new_comment, comment_box.children[1]);
        }
        };
    </script>
{% endblock %}
