{% load static %}
{% if results %}
<table>
    {% for row in results %}
    <tr>
        {% for entry in row %}
        <td style="position: relative; vertical-align:top; border: 5px solid rgba(0,0,0,0);">
            <a href="/track/?id={{entry.0.track_id}}" target="_blank" style="color:white;">
                <div style="display: flex; flex-direction: row; min-width: 500px; max-width: 500px; max-height: 125px; min-height: 125px; padding: 12px; border-radius: 1.25rem; background-color: rgba(255,255,255,.25);">
                    <img src="{{entry.0.image_url}}" style="max-width: 100px; border-radius: 1rem; aspect-ratio: 1/1;"/>
                    <div style="flex-direction: column; margin: auto; margin-left: 24px; margin-right: 70px; max-height: 100px; overflow-y: scroll;">
                        <h4 style="font-weight: bolder;">{{entry.0.track_name}}</h4>
                        <h6>{{entry.0.artist}}</h6>
                    </div>
                </div>
            </a>
            <img src="{% static 'images/down_button.png' %}" frame="{{entry.0.track_id}}" onclick="expand(this)" style="position: absolute; right: 10px; top: 40px; border-radius: 25px; background-color: rgba(255, 255, 255, .5); max-width: 50px; aspect-ratio: 1/1;"/>
            {% if not user.is_authenticated %}
                <div id="{{entry.0.track_id}}" style="position: absolute; z-index: 10; right: -120px; top: 100px; border: 5px solid white; border-radius: 1.1rem; max-width: 310px; height: 362px; background-color: white;" hidden="true">
                    <iframe src="https://open.spotify.com/embed/track/{{ entry.0.track_id }}" width="310" height="362" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
                </div>
            {% else %}
            <div id="{{entry.0.track_id}}" style="display: flex; flex-direction: row; position: absolute; z-index: 10; right: -70px; top: 100px; border: 5px solid white; border-radius: 1.1rem; min-width: 640px; max-width: 640px; height: 362px; background-color: white;" hidden="true">
                <iframe style="max-width: 310px;" src="https://open.spotify.com/embed/track/{{ entry.0.track_id }}" width="310" height="362" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
                <div style="display: flex; flex-direction: column; margin-left: 5px; padding: 12px; min-width: 325px; max-width: 325px; border-radius: .75rem; background-color: rgba(0, 0, 0, .75); color: white;">
                    {% if playlists %}
                    <select name="playlists" id="{{entry.0.track_id}}" style="min-width: 100%; height: 24px;">
                        <option value="" disabled selected>Add to playlist</option>
                        {% for playlist in playlists %}
                            <option value="{{playlist.name}}">{{playlist.name}}</option>
                        {% endfor %}
                            <!--option value="create">Create a new playlist</option>-->
                    </select>
                    {% endif %}
                    <center><h2>Comments</h2></center>
                    <div style="display: flex; flex-direction: column-reverse; width: 100%; background-color:rgba(255, 255, 255, .75); border-radius: .5rem; color: black; flex: 1 1 auto; overflow-y: scroll;">
                        <input type="text" placeholder="Leave a comment" style="background-color:rgba(0,0,0,.5); color: white;" track-id="{{entry.0.track_id}}" onkeypress="if (event.keyCode == 13) { commenting(this); };">
                        {% for comment in entry.1 %}
                        <div title="{{comment.posted_at}}" style="flex-direction: row;  text-align: left; padding-left: 4px; background-color: rgba(0,0,0,.5); margin: 0 4px 4px; color: white; border-radius: .5rem;">
                            <h6 style="display: inline; font-weight: bold;">{{comment.user.username}}: </h6><p style="display: inline;">{{comment.comment}}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </td>
        {% endfor %}
    </tr>
    {% endfor %}
</table>
{% endif %}

{% block scripts %}
    <script>
        function expand(elem) {
            target_id = elem.getAttribute("frame");
            target = document.getElementById(target_id);
            target.hidden = false;
            elem.style.setProperty("transform", "rotate(180deg)");
            elem.setAttribute("onclick", "shrink(this)");
        }
        function shrink(elem) {
            target_id = elem.getAttribute("frame");
            target = document.getElementById(target_id);
            target.hidden = true;
            elem.style.setProperty("transform", "rotate(0deg)");
            elem.setAttribute("onclick", "expand(this)");
        }
        function commenting(elem) {
            let http = new XMLHttpRequest;
            target_id = elem.getAttribute("track-id");
            comment = encodeURIComponent(elem.value);
            let url = '/comment/?track_id=' + target_id + "&comment=" + comment;
            http.open('GET', url);
            http.send(null);
            elem.value = ""
        }
    </script>
{% endblock %}
